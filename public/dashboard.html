<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    
    <script>
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Sora', 'sans-serif'] },
                    colors: {
                        primary: '#ea580c', 
                        darkBg: '#09090b',  
                        darkCard: '#18181b', 
                        darkBar: '#27272a'   
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }
        .pulsing-dot { position: relative; display: flex; align-items: center; justify-content: center; width: 10px; height: 10px; }
        .pulsing-dot::before { content: ''; position: absolute; width: 100%; height: 100%; background-color: #22c55e; border-radius: 50%; z-index: 2; }
        .pulsing-dot::after { content: ''; position: absolute; width: 100%; height: 100%; background-color: #22c55e; border-radius: 50%; animation: pulse-ring 2s infinite; z-index: 1; }
        
        body, div, p, h1, h2, h3, span, button, table, tr, td, th { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

        .trend-badge { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-left: 6px; vertical-align: middle; }
        .trend-up { background-color: #dcfce7; color: #166534; } 
        .dark .trend-up { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .trend-down { background-color: #fee2e2; color: #991b1b; } 
        .dark .trend-down { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .trend-neutral { background-color: #f4f4f5; color: #71717a; } 
        .dark .trend-neutral { background-color: rgba(161, 161, 170, 0.2); color: #a1a1aa; }

        .metric-tab.active { background-color: #fff7ed; border-bottom: 3px solid #ea580c; }
        .metric-tab.active p.label { color: #ea580c; }
        .dark .metric-tab.active { background-color: #18181b; border-bottom: 3px solid #fb923c; } 
        .dark .metric-tab.active p.label { color: #fb923c; }
        
        .clickable-row { cursor: pointer; }
        .clickable-row:hover .item-label { text-decoration: underline; }
    </style>
</head>
<body class="bg-zinc-50 text-zinc-800 dark:bg-darkBg dark:text-zinc-100 font-sans antialiased">

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg flex items-center justify-center shadow-sm text-xl">ðŸ“Š</div>
                <div class="flex flex-col">
                    <h1 class="text-xl font-bold text-zinc-900 dark:text-white leading-tight">Mijn Website</h1>
                    
                    <button onclick="toggleLiveBlock()" class="flex items-center gap-2 mt-1 group cursor-pointer focus:outline-none text-left">
                        <div class="pulsing-dot"></div>
                        <span class="text-sm font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-zinc-900 dark:group-hover:text-white transition-colors">
                            <span id="liveCount" class="font-bold text-zinc-900 dark:text-white">0</span> live bezoekers
                            <span class="text-xs text-zinc-400 ml-1">(Klik voor details)</span>
                        </span>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="bg-white dark:bg-darkCard p-1 rounded-lg border border-zinc-200 dark:border-zinc-700 shadow-sm flex flex-wrap gap-1">
                    <button onclick="setPeriod('today', this)" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-all">Vandaag</button>
                    <button onclick="setPeriod('yesterday', this)" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-all">Gisteren</button>
                    <button onclick="setPeriod(7, this)" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/30 transition-all">7 Dagen</button>
                    <button onclick="setPeriod(30, this)" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-all">30 Dagen</button>
                    <button onclick="setPeriod('all', this)" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white transition-all">Alles</button>
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white dark:bg-darkCard border border-zinc-200 dark:border-zinc-700 text-zinc-500 dark:text-zinc-400 hover:text-orange-600 dark:hover:text-orange-400 transition-colors">
                    <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>

        <div id="filterContainer" class="hidden mb-6">
            <div class="inline-flex items-center bg-white dark:bg-darkCard border border-zinc-200 dark:border-zinc-700 rounded-full px-4 py-1.5 shadow-sm">
                <span class="text-sm text-zinc-500 dark:text-zinc-400 mr-2">Filter:</span>
                <span id="filterLabel" class="text-sm font-semibold text-zinc-800 dark:text-zinc-100 mr-3"></span>
                <button onclick="clearFilter()" class="text-zinc-400 hover:text-red-500 focus:outline-none"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
        </div>

        <div id="liveBlock" class="hidden bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col mb-8 border-l-4 border-l-green-500">
            <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <h3 class="font-semibold text-zinc-700 dark:text-zinc-200">Nu Online</h3>
                </div>
                <button onclick="toggleLiveBlock()" class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-zinc-600 dark:text-zinc-300">
                    <thead class="bg-zinc-50 dark:bg-zinc-800/50 border-b border-zinc-100 dark:border-zinc-700 text-xs uppercase font-semibold text-zinc-500 dark:text-zinc-400">
                        <tr>
                            <th class="px-5 py-3 text-left tracking-wide">Land</th>
                            <th class="px-5 py-3 text-left tracking-wide">Huidige Pagina</th>
                            <th class="px-5 py-3 text-left tracking-wide">Apparaat</th>
                            <th class="px-5 py-3 text-left tracking-wide">Browser</th>
                            <th class="px-5 py-3 text-right tracking-wide">Tijd actief</th>
                            <th class="px-5 py-3 text-right tracking-wide">Laatst gezien</th>
                        </tr>
                    </thead>
                    <tbody id="visitorLogBody" class="divide-y divide-zinc-50 dark:divide-zinc-700"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white dark:bg-darkCard rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-700 mb-8 overflow-hidden transition-colors">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 border-b border-zinc-100 dark:border-zinc-700">
                <div onclick="switchChart('visitors')" class="metric-tab active cursor-pointer p-5 border-r border-b border-zinc-100 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Unieke Bezoekers</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="uniqueVisitors">-</p><span id="trendVisitors" class="trend-badge hidden"></span></div>
                </div>
                <div onclick="switchChart('views')" class="metric-tab cursor-pointer p-5 border-r border-b border-zinc-100 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Total Pageviews</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="totalViewsDisplay">-</p><span id="trendViews" class="trend-badge hidden"></span></div>
                </div>
                <div onclick="switchChart('visits')" class="metric-tab cursor-pointer p-5 border-r border-b border-zinc-100 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Totaal Visits</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="totalVisits">-</p><span id="trendVisits" class="trend-badge hidden"></span></div>
                </div>
                <div class="p-5 border-r border-b border-zinc-100 dark:border-zinc-700 bg-white dark:bg-darkCard">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Views per Visit</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="viewsPerVisit">-</p><span id="trendVPV" class="trend-badge hidden"></span></div>
                </div>
                <div class="p-5 border-r border-b border-zinc-100 dark:border-zinc-700 bg-white dark:bg-darkCard">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Bounce Rate</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="bounceRate">-</p><span id="trendBounce" class="trend-badge hidden"></span></div>
                </div>
                <div class="p-5 border-b border-zinc-100 dark:border-zinc-700 bg-white dark:bg-darkCard">
                    <p class="label text-xs font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400 mb-1">Gem. Tijd</p>
                    <div class="flex items-baseline"><p class="text-2xl font-bold text-zinc-900 dark:text-white" id="avgDuration">-</p><span id="trendDuration" class="trend-badge hidden"></span></div>
                </div>
            </div>
            
            <div class="p-6">
                <h3 class="text-sm font-semibold text-zinc-700 dark:text-zinc-300 mb-4" id="chartTitle">Verloop Unieke Bezoekers</h3>
                <div class="w-full h-80"><canvas id="mainChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col">
                <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50"><h3 class="font-semibold text-zinc-700 dark:text-zinc-200">Top Landen</h3></div>
                <div id="countriesList" class="flex-1 overflow-y-auto max-h-96"></div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col">
                <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50"><h3 class="font-semibold text-zinc-700 dark:text-zinc-200">Top Pagina's</h3></div>
                <div id="pagesList" class="flex-1 overflow-y-auto max-h-96"></div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col">
                <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50"><h3 class="font-semibold text-zinc-700 dark:text-zinc-200">Top Bronnen</h3></div>
                <div id="referrersList" class="flex-1 overflow-y-auto max-h-96"></div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col">
                <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50 flex items-baseline gap-4">
                    <button onclick="switchDeviceTab('browsers')" id="tab-browsers" class="font-semibold text-zinc-700 dark:text-zinc-200 hover:text-zinc-900 dark:hover:text-white focus:outline-none">Browsers</button>
                    <button onclick="switchDeviceTab('devices')" id="tab-devices" class="text-sm font-medium text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200 focus:outline-none">Apparaten</button>
                </div>
                <div id="deviceContainer" class="flex-1 overflow-y-auto max-h-96"></div>
            </div>

            <div class="bg-white dark:bg-darkCard rounded-xl border border-zinc-200 dark:border-zinc-700 shadow-sm overflow-hidden flex flex-col relative md:col-span-2">
                <div class="px-5 py-4 border-b border-zinc-100 dark:border-zinc-700 bg-zinc-50/50 dark:bg-zinc-800/50"><h3 class="font-semibold text-zinc-700 dark:text-zinc-200">Top Doelen (Events)</h3></div>
                <div id="eventsList" class="flex-1 overflow-y-auto max-h-96"></div>
            </div>

        </div>
        
        <div class="mt-12 mb-6 text-center text-xs text-zinc-400">Analytics powered by your own Node.js server.</div>
    </main>

    <script>
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark');
            }
            switchChart(currentMetric); 
        }

        // --- NIEUW: Toggle Live Block ---
        function toggleLiveBlock() {
            const block = document.getElementById('liveBlock');
            block.classList.toggle('hidden');
            if (!block.classList.contains('hidden')) {
                block.scrollIntoView({ behavior: 'smooth' });
                loadData(currentFrom, currentTo, currentUnit); 
            }
        }

        let myChart = null;
        let chartDataVisitors = {}, chartDataViews = {}, chartDataVisits = {};
        let currentMetric = 'visitors';
        let loadedDeviceData = { browsers: {}, devices: {} }; 
        let currentDeviceTab = 'browsers';
        let currentFrom = null, currentTo = null, currentUnit = 'day';
        let activeFilter = { type: null, value: null };

        function getBrowserIconPath(label) { const name = label.toLowerCase(); if (name.includes('chrome')) return '/icons/chrome.svg'; if (name.includes('safari')) return '/icons/safari.svg'; if (name.includes('firefox')) return '/icons/firefox.svg'; if (name.includes('edge')) return '/icons/edge.svg'; if (name.includes('opera')) return '/icons/opera.svg'; if (name.includes('samsung')) return '/icons/samsung.svg'; if (name.includes('android')) return '/icons/android.svg'; return null; }
        function getDeviceIconSvg(label) { const l = label.toLowerCase(); const icons = { mobile: '<path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>', tablet: '<path d="M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-2 14H5V6h14v12z"/>', desktop: '<path d="M20 18c1.1 0 1.99-.9 1.99-2L22 5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2H0c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2h-4zM4 5h16v11H4V5z"/>' }; if (l.includes('mobile')) return icons.mobile; if (l.includes('tablet')) return icons.tablet; return icons.desktop; }
        function getCountryIconPath(label) { const code = label.split(' ').pop().toLowerCase(); return `/icons/flags/${code}.svg`; }

        // --- RENDER VISITOR LOG (MET LIVE FILTER) ---
        function renderVisitorLog(data) {
            const tbody = document.getElementById('visitorLogBody'); tbody.innerHTML = '';
            
            // 1. Group by Session
            const sessions = {};
            data.forEach(view => {
                if (!sessions[view.sessionId]) sessions[view.sessionId] = view;
                else if (new Date(view.timestamp) > new Date(sessions[view.sessionId].timestamp)) {
                    const oldDur = sessions[view.sessionId].duration || 0;
                    sessions[view.sessionId] = view;
                    sessions[view.sessionId].duration = Math.max(oldDur, view.duration || 0);
                }
            });

            // 2. FILTER: Alleen Live bezoekers (laatste 5 minuten)
            const now = new Date();
            const liveSessions = Object.values(sessions).filter(v => {
                const diff = now - new Date(v.timestamp);
                return diff < (5 * 60 * 1000); // 5 min
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (liveSessions.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="6" class="px-5 py-4 text-center text-zinc-400">Er zijn momenteel geen actieve bezoekers.</td></tr>'; 
                return; 
            }

            liveSessions.forEach(visit => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-zinc-50 dark:hover:bg-zinc-700/50 transition-colors border-b border-zinc-50 dark:border-zinc-700 last:border-0';
                
                const browserPath = getBrowserIconPath(visit.browser);
                const browserIcon = browserPath ? `<img src="${browserPath}" class="w-4 h-4 object-contain mr-2 block">` : '';
                const deviceIcon = `<svg class="w-4 h-4 fill-zinc-400 mr-2 block" viewBox="0 0 24 24">${getDeviceIconSvg(visit.device)}</svg>`;
                const rawCountry = visit.country || 'Onbekend';
                const countryPath = getCountryIconPath(rawCountry);
                const countryIcon = `<img src="${countryPath}" class="w-4 h-4 object-contain mr-2 block rounded-full" onerror="this.style.display='none'">`;
                const cleanCountryName = rawCountry.split(' ').pop();
                const visitTime = new Date(visit.timestamp);
                const timeString = visitTime.toLocaleTimeString('nl-NL', {hour: '2-digit', minute:'2-digit'});
                const dur = visit.duration || 0; let durString = dur < 60 ? `${dur}s` : `${Math.floor(dur/60)}m ${dur%60}s`; if (dur === 0) durString = 'net binnen';
                
                // Status is altijd groen hier want we filteren op live
                const statusDot = `<span class="flex-shrink-0 w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>`;

                tr.innerHTML = `<td class="px-5 py-3 align-middle whitespace-nowrap text-sm font-medium text-zinc-700 dark:text-zinc-300"><div class="flex items-center">${countryIcon}${cleanCountryName}</div></td><td class="px-5 py-3 align-middle whitespace-nowrap text-sm text-zinc-600 dark:text-zinc-400"><div class="flex items-center">${statusDot}<span class="truncate max-w-[150px] inline-block" title="${visit.url}">${new URL(visit.url).pathname}</span></div></td><td class="px-5 py-3 align-middle whitespace-nowrap text-sm text-zinc-600 dark:text-zinc-400"><div class="flex items-center">${deviceIcon}<span>${visit.device}</span></div></td><td class="px-5 py-3 align-middle whitespace-nowrap text-sm text-zinc-600 dark:text-zinc-400"><div class="flex items-center">${browserIcon}<span>${visit.browser}</span></div></td><td class="px-5 py-3 align-middle whitespace-nowrap text-right text-sm font-mono text-zinc-500 dark:text-zinc-400"><div class="flex items-center justify-end"><svg class="w-3 h-3 text-zinc-400 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${durString}</div></td><td class="px-5 py-3 align-middle whitespace-nowrap text-right text-xs text-zinc-400">${timeString}</td>`;
                tbody.appendChild(tr);
            });
        }

        function renderList(elementId, dataObj, listType = null) { 
            const container = document.getElementById(elementId); container.innerHTML = ''; 
            const sorted = Object.entries(dataObj).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (sorted.length === 0) { container.innerHTML = '<div class="p-6 text-center text-zinc-400 text-sm">Nog geen data beschikbaar</div>'; return; }
            const maxVal = sorted[0][1]; 
            sorted.forEach(([label, count]) => {
                const percentage = Math.round((count / maxVal) * 100);
                const div = document.createElement('div');
                div.className = 'relative flex justify-between items-center px-5 py-3 border-b border-zinc-50 dark:border-zinc-700 last:border-0 hover:bg-zinc-50 dark:hover:bg-zinc-700/50 transition-colors group cursor-pointer';
                
                let filterType = '';
                if (elementId === 'pagesList') filterType = 'url';
                else if (elementId === 'countriesList') filterType = 'country';
                else if (elementId === 'referrersList') filterType = 'referrer';
                else if (elementId === 'eventsList') filterType = 'eventName';
                else if (listType === 'browser') filterType = 'browser';
                else if (listType === 'device') filterType = 'device';
                if (filterType) div.onclick = () => setFilter(filterType, label);

                let iconHtml = ''; const iconStyle = 'width: 16px; height: 16px; margin-right: 12px; object-fit: contain; display: block; flex-shrink: 0;';
                let displayLabel = label;
                if (listType === 'browser') { const imgPath = getBrowserIconPath(label); if (imgPath) iconHtml = `<img src="${imgPath}" style="${iconStyle}" alt="">`; else iconHtml = `<svg style="${iconStyle}" class="fill-current text-zinc-300" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-1.07 3.97-2.9 5.39z"/></svg>`; } else if (listType === 'device') { const svgPath = getDeviceIconSvg(label); iconHtml = `<svg style="${iconStyle}" class="fill-current text-zinc-400" viewBox="0 0 24 24">${svgPath}</svg>`; } else if (listType === 'country') { const flagPath = getCountryIconPath(label); iconHtml = `<img src="${flagPath}" style="${iconStyle}" class="rounded-full" onerror="this.style.display='none'">`; displayLabel = label.split(' ').pop(); }
                div.innerHTML = `<div class="absolute top-0 left-0 bottom-0 bg-orange-50/60 dark:bg-darkBar z-0 transition-all duration-500 rounded-r-md" style="width: ${percentage}%"></div><div class="relative z-10 flex items-center min-w-0 pr-4 flex-1">${iconHtml}<span class="text-sm font-medium text-zinc-700 dark:text-zinc-300 truncate item-label" title="${label}">${displayLabel}</span></div><span class="relative z-10 text-sm text-zinc-600 dark:text-zinc-400 font-bold font-variant-numeric flex-shrink-0 ml-2">${count}</span>`;
                container.appendChild(div);
            });
        }

        function switchChart(metric) { currentMetric = metric; document.querySelectorAll('.metric-tab').forEach(el => { el.classList.remove('active'); el.querySelector('.label').classList.remove('text-primary'); }); event.currentTarget.classList.add('active'); let title = 'Verloop'; let data = {}; if (metric === 'visitors') { title = 'Verloop Unieke Bezoekers'; data = chartDataVisitors; } else if (metric === 'views') { title = 'Verloop Total Pageviews'; data = chartDataViews; } else if (metric === 'visits') { title = 'Verloop Totaal Visits (Sessies)'; data = chartDataVisits; } document.getElementById('chartTitle').innerText = title; renderChart(data, metric); }
        function switchDeviceTab(tab) { currentDeviceTab = tab; const btnB = document.getElementById('tab-browsers'); const btnD = document.getElementById('tab-devices'); const activeClass = ['font-semibold', 'text-zinc-700', 'dark:text-zinc-200', 'text-base']; const inactiveClass = ['font-medium', 'text-zinc-400', 'text-sm']; if (tab === 'browsers') { btnB.classList.add(...activeClass); btnB.classList.remove(...inactiveClass); btnD.classList.remove(...activeClass); btnD.classList.add(...inactiveClass); renderList('deviceContainer', loadedDeviceData.browsers, 'browser'); } else { btnD.classList.add(...activeClass); btnD.classList.remove(...inactiveClass); btnB.classList.remove(...activeClass); btnB.classList.add(...inactiveClass); renderList('deviceContainer', loadedDeviceData.devices, 'device'); } }
        function calculateMetrics(data) { const uniqueIds = new Set(); const sessions = {}; data.forEach(view => { uniqueIds.add(view.visitorId); if (!sessions[view.sessionId]) sessions[view.sessionId] = { views: 0, duration: 0 }; sessions[view.sessionId].views++; sessions[view.sessionId].duration += (view.duration || 0); }); const totalSessions = Object.keys(sessions).length; let singlePage = 0, totalDur = 0; Object.values(sessions).forEach(s => { if(s.views===1) singlePage++; totalDur += s.duration; }); const vpv = totalSessions ? (data.length / totalSessions).toFixed(1) : 0; return { visitors: uniqueIds.size, views: data.length, visits: totalSessions, vpv: vpv, bounce: totalSessions ? Math.round((singlePage/totalSessions)*100) : 0, duration: totalSessions ? Math.round(totalDur / totalSessions) : 0 }; }
        function renderTrend(elementId, current, previous, inverse = false) { const el = document.getElementById(elementId); if (previous === 0) { el.classList.add('hidden'); return; } el.classList.remove('hidden', 'trend-up', 'trend-down', 'trend-neutral'); const diff = current - previous; const percentage = Math.round((diff / previous) * 100); if (percentage === 0) { el.innerText = '0%'; el.classList.add('trend-neutral'); return; } const arrow = percentage > 0 ? 'â†‘' : 'â†“'; el.innerText = `${arrow} ${Math.abs(percentage)}%`; let isGood = percentage > 0; if (inverse) isGood = !isGood; if (percentage > 0) el.classList.add(isGood ? 'trend-up' : 'trend-down'); else el.classList.add(isGood ? 'trend-up' : 'trend-down'); }
        
        function processData(data, timeUnit = 'day') {
            const counts = { pages: {}, referrers: {}, devices: {}, browsers: {}, countries: {}, events: {} };
            chartDataVisitors = {}; chartDataViews = {}; chartDataVisits = {}; 
            const chartDataVisitsTemp = {}; 
            
            if (currentFrom && currentTo) {
                let start = new Date(currentFrom);
                let end = new Date(currentTo);
                if (timeUnit === 'hour') {
                    for(let i=0; i<24; i++) {
                        const h = i.toString().padStart(2, '0') + ':00';
                        chartDataViews[h] = 0; chartDataVisitors[h] = new Set(); chartDataVisitsTemp[h] = new Set();
                    }
                } else {
                    while (start <= end) {
                        const dayKey = start.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
                        chartDataViews[dayKey] = 0; chartDataVisitors[dayKey] = new Set(); chartDataVisitsTemp[dayKey] = new Set();
                        start.setDate(start.getDate() + 1);
                    }
                }
            }

            data.forEach(view => {
                const country = view.country || 'Onbekend'; if(!counts.countries[country]) counts.countries[country] = new Set(); counts.countries[country].add(view.visitorId);
                const p = new URL(view.url).pathname; if(!counts.pages[p]) counts.pages[p] = new Set(); counts.pages[p].add(view.visitorId);
                let ref = view.referrer; if (!ref || ref.includes(window.location.hostname) || ref === 'Direct') ref = 'Direct'; else try { ref = new URL(ref).hostname; } catch {} if(!counts.referrers[ref]) counts.referrers[ref] = new Set(); counts.referrers[ref].add(view.visitorId);
                const dev = view.device || 'Onbekend'; if(!counts.devices[dev]) counts.devices[dev] = new Set(); counts.devices[dev].add(view.visitorId);
                const brow = view.browser || 'Onbekend'; if(!counts.browsers[brow]) counts.browsers[brow] = new Set(); counts.browsers[brow].add(view.visitorId);
                if (view.eventName) { if (!counts.events[view.eventName]) counts.events[view.eventName] = new Set(); counts.events[view.eventName].add(view.visitorId); }

                const dateObj = new Date(view.timestamp);
                let key; if (timeUnit === 'hour') key = dateObj.getHours().toString().padStart(2, '0') + ':00'; else key = dateObj.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
                if (chartDataViews[key] === undefined) { chartDataViews[key] = 0; chartDataVisitors[key] = new Set(); chartDataVisitsTemp[key] = new Set(); }
                chartDataViews[key]++; chartDataVisitors[key].add(view.visitorId); chartDataVisitsTemp[key].add(view.sessionId);
            });

            Object.keys(chartDataVisitors).forEach(k => { if(chartDataVisitors[k] instanceof Set) chartDataVisitors[k] = chartDataVisitors[k].size; });
            Object.keys(chartDataVisitsTemp).forEach(k => { if(chartDataVisitsTemp[k] instanceof Set) chartDataVisits[k] = chartDataVisitsTemp[k].size; else chartDataVisits[k] = chartDataVisitsTemp[k]; });

            const convert = (obj) => { const n={}; Object.keys(obj).forEach(k=>n[k]=obj[k].size); return n; };
            renderList('countriesList', convert(counts.countries), 'country'); renderList('pagesList', convert(counts.pages)); renderList('referrersList', convert(counts.referrers)); renderList('eventsList', convert(counts.events));
            loadedDeviceData.browsers = convert(counts.browsers); loadedDeviceData.devices = convert(counts.devices);
            
            renderVisitorLog(data);
            switchDeviceTab(currentDeviceTab);
            let dataToRender; if(currentMetric === 'visitors') dataToRender = chartDataVisitors; else if(currentMetric === 'views') dataToRender = chartDataViews; else if(currentMetric === 'visits') dataToRender = chartDataVisits;
            renderChart(dataToRender, currentMetric);
        }

        function renderChart(dataObj, metricType) { 
            if (myChart) myChart.destroy(); 
            const ctx = document.getElementById('mainChart'); 
            let sortedKeys = Object.keys(dataObj); 
            if (sortedKeys.length > 0 && sortedKeys[0].includes(':')) sortedKeys.sort(); else { const currentYear = new Date().getFullYear(); sortedKeys.sort((a,b) => { const dateA = new Date(a + " " + currentYear); const dateB = new Date(b + " " + currentYear); return dateA - dateB; }); }
            
            const isDark = document.documentElement.classList.contains('dark');
            let color = isDark ? '#fb923c' : '#ea580c'; 
            if (metricType === 'views') color = isDark ? '#34d399' : '#10B981'; 
            if (metricType === 'visits') color = isDark ? '#38bdf8' : '#0ea5e9'; 

            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400); 
            gradient.addColorStop(0, color + '33'); gradient.addColorStop(1, color + '00'); 
            let label = 'Unieke Bezoekers'; if (metricType === 'views') label = 'Total Pageviews'; if (metricType === 'visits') label = 'Totaal Visits'; 
            
            myChart = new Chart(ctx, { 
                type: 'line', 
                data: { labels: sortedKeys, datasets: [{ label: label, data: sortedKeys.map(d => dataObj[d]), borderColor: color, backgroundColor: gradient, borderWidth: 3, tension: 0.3, fill: true, pointRadius: 0, pointHoverRadius: 6, pointHitRadius: 20, pointBackgroundColor: isDark ? '#1e293b' : '#fff', pointBorderColor: color, pointBorderWidth: 2 }] }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: isDark ? '#27272a' : '#1E293B', padding: 12, titleFont: {family:'Sora', size:13}, bodyFont: {family:'Sora', size:14, weight:'bold'}, displayColors: false, intersect: false, mode: 'index' } }, 
                    scales: { 
                        y: { beginAtZero: true, suggestedMax: 5, grid: { borderDash: [4, 4], color: isDark ? '#27272a' : '#E2E8F0' }, ticks: { stepSize: 1, font: {family: 'Sora', weight:'500'}, color: isDark ? '#a1a1aa' : '#64748B' } }, 
                        x: { grid: { display: false }, ticks: { font: {family: 'Sora', weight:'500'}, color: isDark ? '#a1a1aa' : '#64748B', maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } } 
                    }, interaction: { intersect: false, mode: 'index' } 
                } 
            }); 
        }
        
        function fmt(date) { return date.toISOString().split('T')[0]; }
        
        function setFilter(type, value) {
            activeFilter = { type, value };
            document.getElementById('filterContainer').classList.remove('hidden');
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById('filterLabel').innerText = `${typeLabel}: ${value}`;
            loadData(currentFrom, currentTo, currentUnit);
        }

        function clearFilter() {
            activeFilter = { type: null, value: null };
            document.getElementById('filterContainer').classList.add('hidden');
            loadData(currentFrom, currentTo, currentUnit);
        }

        function setPeriod(range, btn) { document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('text-orange-600', 'dark:text-orange-400', 'bg-orange-50', 'dark:bg-orange-900/30'); b.classList.add('text-zinc-500', 'dark:text-zinc-400'); }); btn.classList.remove('text-zinc-500', 'dark:text-zinc-400'); btn.classList.add('text-orange-600', 'dark:text-orange-400', 'bg-orange-50', 'dark:bg-orange-900/30'); const now = new Date(); let from = null; let to = null; let unit = 'day'; if (range === 'today') { from = fmt(now); to = fmt(now); unit = 'hour'; } else if (range === 'yesterday') { now.setDate(now.getDate() - 1); from = fmt(now); to = fmt(now); unit = 'hour'; } else if (range === 'all') { /* null */ } else { to = fmt(now); now.setDate(now.getDate() - range); from = fmt(now); } loadData(from, to, unit); }
        async function loadData(from, to, timeUnit = 'day') { 
            currentFrom = from; currentTo = to; currentUnit = timeUnit;
            try { 
                let url = '/api/stats'; 
                const params = new URLSearchParams();
                if (from) params.append('from', from);
                if (to) params.append('to', to);
                if (activeFilter.type && activeFilter.value) {
                    params.append('filterType', activeFilter.type);
                    params.append('filterValue', encodeURIComponent(activeFilter.value));
                }
                url += '?' + params.toString();

                let prevUrl = null; 
                if (from && to) { 
                    const startCurrent = new Date(from); const endCurrent = new Date(to); const diffTime = Math.abs(endCurrent - startCurrent); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; const endPrev = new Date(startCurrent); endPrev.setDate(endPrev.getDate() - 1); const startPrev = new Date(endPrev); startPrev.setDate(startPrev.getDate() - (diffDays - 1)); 
                    const prevParams = new URLSearchParams();
                    prevParams.append('from', fmt(startPrev)); prevParams.append('to', fmt(endPrev));
                    if (activeFilter.type && activeFilter.value) { prevParams.append('filterType', activeFilter.type); prevParams.append('filterValue', encodeURIComponent(activeFilter.value)); }
                    prevUrl = '/api/stats?' + prevParams.toString();
                } 
                
                const promises = [fetch(url)]; if (prevUrl) promises.push(fetch(prevUrl)); else document.querySelectorAll('.trend-badge').forEach(e => e.classList.add('hidden')); 
                const responses = await Promise.all(promises); const currData = await responses[0].json(); const prevData = responses[1] ? await responses[1].json() : []; 
                const currStats = calculateMetrics(currData); const prevStats = calculateMetrics(prevData); 
                document.getElementById('uniqueVisitors').innerText = currStats.visitors; document.getElementById('totalViewsDisplay').innerText = currStats.views; document.getElementById('totalVisits').innerText = currStats.visits; document.getElementById('viewsPerVisit').innerText = currStats.vpv; document.getElementById('bounceRate').innerText = currStats.bounce + '%'; document.getElementById('avgDuration').innerText = `${Math.floor(currStats.duration/60)}m ${currStats.duration%60}s`; 
                if (prevData.length > 0 || (prevUrl && prevData.length === 0)) { renderTrend('trendVisitors', currStats.visitors, prevStats.visitors); renderTrend('trendViews', currStats.views, prevStats.views); renderTrend('trendVisits', currStats.visits, prevStats.visits); renderTrend('trendVPV', currStats.vpv, prevStats.vpv); renderTrend('trendBounce', currStats.bounce, prevStats.bounce, true); renderTrend('trendDuration', currStats.duration, prevStats.duration); } 
                processData(currData, timeUnit); 
            } catch (err) { console.error("Load error:", err); } 
        }
        
        async function checkRealtime() { try { const res = await fetch('/api/realtime'); const data = await res.json(); document.getElementById('liveCount').innerText = data.visitors; if(data.visitors > 0) document.title = `(${data.visitors}) Analytics`; else document.title = 'Analytics'; } catch(e) {} }

        const defaultBtn = document.querySelectorAll('.filter-btn')[2]; 
        setPeriod(7, defaultBtn); 
        checkRealtime(); setInterval(checkRealtime, 5000);
    </script>
</body>
</html>